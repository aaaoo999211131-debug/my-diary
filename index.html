<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è«è˜­è¿ªï½œå¥¶æ²¹æ—¥èªŒ V63 (æ¥µç´°ç²¾ç·»ç‰ˆ)</title>
    <style>
        :root {
            --bg-page: #F2EEE5;           
            --bg-paper: #FFFFFF;
            --text-deep: #4A443F;
            --text-soft: #8C847E;
            --m-brown: #BFA891;           
            --m-pink: #D6A8A8;            
            --border-heavy: #D1C9BC;
            --border-light: #F0EBE3;
            --weekend-red: #C57B7B;
            --danger-red: #E6A2A2;
            --success-green: #AAB096;
        }

        * { -webkit-tap-highlight-color: transparent; font-family: -apple-system, "PingFang TC", "Noto Sans TC", sans-serif; color: var(--text-deep) !important; box-sizing: border-box; }
        body { background-color: var(--bg-page); margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        .main-wrapper { 
            display: flex; width: 100%; height: 100vh; 
            background: var(--bg-paper); 
            position: relative; overflow: hidden; 
        }

        /* å´é‚Šæ¬„è¨­è¨ˆ */
        .sidebar { 
            width: 330px; background: #FAF9F6; border-right: 1.5px solid var(--border-light); 
            padding: 30px 25px 120px 25px; 
            display: flex; flex-direction: column; gap: 14px; 
            position: absolute; left: -330px; top: 0; height: 100%; z-index: 200; 
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); 
            overflow-y: auto;
        }
        .sidebar.active { transform: translateX(330px); }

        .tab-header { display: flex; gap: 10px; margin-bottom: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: 1.5px solid var(--border-heavy); background: #FFF; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 0.85rem; }
        .tab-btn.active { background: var(--m-brown); color: #FFF !important; border-color: var(--m-brown); }

        .field { display: flex; flex-direction: column; gap: 5px; }
        .field label { font-size: 0.8rem; font-weight: 800; color: var(--text-soft) !important; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid var(--border-heavy); border-radius: 12px; background: #FFF; font-size: 1rem; outline: none; }

        .time-box { display: flex; align-items: center; gap: 10px; background: #FDFBF8; padding: 8px; border-radius: 12px; border: 1px solid var(--border-light); }
        .time-box select { flex: 1; border: 1px solid var(--border-heavy); text-align: center; padding: 8px; background: #FFF; font-weight: 700; font-size: 1rem; }

        .save-btn { background: var(--m-brown); color: #FFF !important; border: none; padding: 18px; border-radius: 15px; font-weight: 800; cursor: pointer; font-size: 1.1rem; }
        
        .sidebar-footer { position: sticky; bottom: -30px; left: 0; width: 100%; background: linear-gradient(to top, #FAF9F6 80%, transparent); padding: 20px 0; margin-top: auto; }
        .back-btn { width: 100%; background: #FFF; color: var(--m-brown) !important; border: 1.5px solid var(--m-brown); padding: 15px; border-radius: 18px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* æ—¥æ›†å€åŸŸ */
        .calendar-content { flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        .calendar-header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: #FFF; border-bottom: 1.5px solid var(--border-light); }
        #headerTitle { cursor: pointer; font-size: 1.6rem; font-weight: 900; color: var(--m-brown) !important; letter-spacing: 1px; }

        .grid-container { flex: 1; overflow: auto; background: var(--border-light); }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(7, minmax(130px, 1fr)); 
            min-width: 100%; min-height: 100%; gap: 1px; 
        }

        .weekday { text-align: center; padding: 15px 0; font-size: 0.75rem; font-weight: 800; background: #FDFBF8; position: sticky; top: 0; z-index: 10; border-bottom: 1.5px solid var(--border-heavy); }
        .weekday:nth-child(1), .weekday:nth-child(7) { color: var(--weekend-red) !important; }

        .day-cell { padding: 8px; display: flex; flex-direction: column; background: #FFF; cursor: pointer; position: relative; min-height: 130px; transition: background 0.2s; }
        .day-cell.other-month { opacity: 0.3; background: #FCFBFA; }
        
        .num-box { display: flex; align-items: baseline; gap: 6px; margin-bottom: 8px; }
        .num { font-size: 1.1rem; font-weight: 800; }
        .lunar { font-size: 0.65rem; font-weight: 800; color: var(--text-soft) !important; }
        
        .day-cell.is-holiday .num, .day-cell.is-holiday .lunar { color: var(--weekend-red) !important; }
        .day-cell.today .num { color: var(--m-pink) !important; border-bottom: 2px solid var(--m-pink); }
        .holiday-tag { position: absolute; top: 8px; right: 8px; font-size: 0.55rem; color: var(--weekend-red) !important; font-weight: 900; background: rgba(197, 123, 123, 0.05); padding: 1px 4px; border-radius: 3px; }

        /* è¡Œç¨‹æ¨™ç±¤ï¼šä¿®æ­£ç‚ºæ¥µç´°æ¡†ç·šè¨­è¨ˆ */
        .task-tag { 
            font-size: 0.75rem; padding: 2px 8px; margin-bottom: 4px; 
            border-left: 2px solid transparent; /* æ¥µç´°è‰²æ¢ */
            display: block; line-height: 1.4; 
            background: transparent; /* å–æ¶ˆå¯¦é«”èƒŒæ™¯ï¼Œæ”¹ç”¨è¼•å¾®åº•è‰²æ–¼ type */
            word-wrap: break-word; 
            white-space: normal; 
            border-top: none; border-right: none; border-bottom: none;
            border-radius: 0; /* å›æ­¸æ´—éŠæ„Ÿ */
        }
        .task-tag.is-done { opacity: 0.3; filter: grayscale(1); }
        .task-tag.is-done .t-text { text-decoration: line-through; }

        .t-time-text { font-weight: 800; font-size: 0.6rem; opacity: 0.5; display: block; }
        .t-text { font-weight: 800; display: block; }

        .type-work { border-left-color: var(--m-brown); background: rgba(191, 168, 145, 0.08); }
        .type-life { border-left-color: var(--m-pink); background: rgba(214, 168, 168, 0.08); }
        .type-urgent { border-left-color: var(--success-green); background: rgba(170, 176, 150, 0.08); }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(74, 68, 63, 0.2); backdrop-filter: blur(2px); z-index: 150; }
        .nav-btn { background: #FFF; border: 1.5px solid var(--border-heavy); border-radius: 10px; padding: 6px 14px; cursor: pointer; font-weight: 800; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; left: -100%; }
            .sidebar.active { transform: translateX(100%); }
            .grid { grid-template-columns: repeat(7, minmax(105px, 1fr)); }
            #headerTitle { font-size: 1.3rem; }
        }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleSidebar(false)"></div>

<div class="main-wrapper">
    <div class="sidebar" id="sidebar">
        <div class="tab-header">
            <button class="tab-btn active" id="btnForm" onclick="switchTab('form')">æ–°å¢è¡Œç¨‹</button>
            <button class="tab-btn" id="btnList" onclick="switchTab('list')">å…¨éƒ¨æ¸…å–®</button>
        </div>
        
        <div id="tabForm" style="display:flex; flex-direction:column; gap:14px;">
            <h3 style="margin:0; color: var(--m-brown) !important;">DASHBOARD</h3>
            <input type="hidden" id="editId">
            <div class="field"><label>æ—¥æœŸ DATE</label><input type="date" id="inDate"></div>
            
            <div class="field" style="flex-direction:row; align-items:center; gap:10px;">
                <input type="checkbox" id="timeToggle" style="width:18px; height:18px;" checked onchange="updateTimeVisibility()">
                <label style="margin:0; cursor: pointer; font-size: 0.85rem; font-weight: 800;" for="timeToggle">é–‹å•Ÿæ™‚é–“é¡¯ç¤º</label>
            </div>

            <div id="timePickerSection">
                <div class="field"><label>é–‹å§‹ START</label><div class="time-box"><select id="sh"></select>:<select id="sm"></select></div></div>
                <div class="field" style="margin-top:10px;"><label>çµæŸ END</label><div class="time-box"><select id="eh"></select>:<select id="em"></select></div></div>
            </div>

            <div class="field"><label>è¨ˆç•« TASK</label><input type="text" id="inText" placeholder="..."></div>
            <div class="field"><label>å‚™å¿˜ MEMO</label><textarea id="inMemo" style="height: 60px;" placeholder="..."></textarea></div>
            <div class="field"><label>åˆ†é¡ TYPE</label><select id="inType"><option value="work">æä»æ£• (å·¥ä½œ)</option><option value="life">ç°éœ§ç²‰ (ç”Ÿæ´»)</option><option value="urgent">é¼ å°¾è‰ (é‡è¦)</option></select></div>
            
            <button class="save-btn" onclick="saveTask()">å„²å­˜è¨ˆç•«</button>
            
            <div id="actionBtns" style="display: none; flex-direction: column; gap: 8px; margin-top: 10px; border-top: 1.5px dashed var(--border-heavy); padding-top: 15px;">
                <button onclick="toggleTaskDone()" style="background:#FFF; border:1.5px solid var(--success-green); color:var(--success-green)!important; padding:12px; border-radius:15px; font-weight:800; cursor:pointer;">âœ… æ¨™è¨˜å®Œæˆ</button>
                <button onclick="deleteCurrentTask()" style="background:#FFF; border:1.5px solid var(--danger-red); color:var(--danger-red)!important; padding:12px; border-radius:15px; font-weight:800; cursor:pointer;">ğŸ—‘ï¸ åˆªé™¤è¡Œç¨‹</button>
            </div>

            <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="nav-btn" onclick="exportData()" style="font-size: 0.75rem;">ğŸ“¤ åŒ¯å‡ºä»£ç¢¼</button>
                <button class="nav-btn" onclick="importData()" style="font-size: 0.75rem;">ğŸ“¥ åŒ¯å…¥ä»£ç¢¼</button>
            </div>
        </div>
        <div id="tabList" style="display:none;"><div id="fullListContainer"></div></div>
        <div class="sidebar-footer"><button class="back-btn" onclick="toggleSidebar(false)"><span>â®</span> è¿”å›æ—¥æ›†</button></div>
    </div>

    <div class="calendar-content">
        <div class="calendar-header">
            <div id="headerTitle" onclick="handleTitleClick()">è«è˜­è¿ªï½œå¥¶æ²¹æ—¥èªŒ</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="nav-btn" onclick="moveMonth(-1)">â®</button>
                <span id="monthDisplay" style="font-weight: 900; font-size: 1.1rem; min-width: 90px; text-align: center;"></span>
                <button class="nav-btn" onclick="moveMonth(1)">â¯</button>
            </div>
        </div>
        <div class="grid-container">
            <div class="grid" id="mainGrid">
                <div class="weekday">SUN</div><div class="weekday">MON</div><div class="weekday">TUE</div><div class="weekday">WED</div><div class="weekday">THU</div><div class="weekday">FRI</div><div class="weekday">SAT</div>
            </div>
        </div>
    </div>
</div>

<script>
    const holidayData = { "01-01": "å…ƒæ—¦", "02-28": "å’Œå¹³", "04-04": "å…’ç«¥", "04-05": "æ¸…æ˜", "05-01": "å‹å‹•", "10-10": "åœ‹æ…¶", "12-25": "è–èª•", "2026-02-13": "å°å¹´å¤œ", "2026-02-16": "é™¤å¤•", "2026-02-17": "åˆä¸€", "2026-02-18": "åˆäºŒ", "2026-02-19": "åˆä¸‰", "2026-02-20": "åˆå››", "2026-02-21": "åˆäº”", "2026-06-19": "ç«¯åˆ", "2026-09-25": "ä¸­ç§‹" };
    function getLunarDay(date) {
        const lunarDays = ["", "åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå", "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå", "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"];
        const baseDate = new Date(2026, 1, 17);
        const diffDays = Math.floor((date - baseDate) / (1000 * 60 * 60 * 24));
        let idx = Math.floor(((diffDays % 29.5) + 30) % 29.5) + 1;
        return lunarDays[idx > 30 ? 1 : idx];
    }
    let db = JSON.parse(localStorage.getItem('creamy_v63')) || [];
    let viewDate = new Date();
    let titleClicks = 0;

    function render() {
        const grid = document.getElementById('mainGrid');
        const labels = Array.from(grid.querySelectorAll('.weekday'));
        grid.innerHTML = ''; labels.forEach(l => grid.appendChild(l));
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('monthDisplay').innerText = `${y} . ${String(m + 1).padStart(2, '0')}`;
        const startDate = new Date(y, m, 1 - new Date(y, m, 1).getDay());
        
        for (let i = 0; i < 42; i++) {
            const current = new Date(startDate); current.setDate(startDate.getDate() + i);
            const dateStr = current.toLocaleDateString('en-CA');
            const cell = document.createElement('div'); cell.className = 'day-cell';
            const mmdd = dateStr.slice(5);
            const hName = holidayData[dateStr] || holidayData[mmdd];
            if (current.getDay() === 0 || current.getDay() === 6 || hName) cell.classList.add('is-holiday');
            if (hName) cell.innerHTML += `<div class="holiday-tag">${hName}</div>`;
            if (current.getMonth() !== m) cell.classList.add('other-month');
            if (dateStr === new Date().toLocaleDateString('en-CA')) cell.classList.add('today');

            cell.onclick = (e) => { if(!e.target.closest('.task-tag')) { clearForm(); document.getElementById('inDate').value = dateStr; toggleSidebar(true); switchTab('form'); } };

            const numBox = document.createElement('div'); numBox.className = 'num-box';
            numBox.innerHTML = `<span class="num">${current.getDate()}</span><span class="lunar">${getLunarDay(current)}</span>`;
            cell.appendChild(numBox);

            db.filter(t => t.date === dateStr).sort((a,b) => (a.st || "24:00").localeCompare(b.st || "24:00")).forEach(t => {
                const tag = document.createElement('div'); tag.className = `task-tag type-${t.type} ${t.done ? 'is-done' : ''}`;
                tag.innerHTML = `${t.hasTime ? `<span class="t-time-text">${t.st} - ${t.et}</span>` : ""}<span class="t-text">${t.text}</span>`;
                tag.onclick = (e) => { e.stopPropagation(); openEdit(t.id); }; cell.appendChild(tag);
            });
            grid.appendChild(cell);
        }
    }

    function init() {
        const hs = [document.getElementById('sh'), document.getElementById('eh')], ms = [document.getElementById('sm'), document.getElementById('em')];
        for(let i=0; i<24; i++) { let v = i.toString().padStart(2, '0'); hs.forEach(s => s.add(new Option(v, v))); }
        for(let i=0; i<60; i+=5) { let v = i.toString().padStart(2, '0'); ms.forEach(s => s.add(new Option(v, v))); }
        document.getElementById('inDate').value = new Date().toLocaleDateString('en-CA');
        updateTimeVisibility(); render();
    }
    function saveTask() {
        const id = document.getElementById('editId').value || Date.now().toString();
        const taskData = { id, date: document.getElementById('inDate').value, text: document.getElementById('inText').value.trim() || "æœªå‘½å", memo: document.getElementById('inMemo').value.trim(), type: document.getElementById('inType').value, hasTime: document.getElementById('timeToggle').checked, st: document.getElementById('sh').value + ":" + document.getElementById('sm').value, et: document.getElementById('eh').value + ":" + document.getElementById('em').value, done: id ? (db.find(x=>x.id===id)?.done || false) : false };
        const idx = db.findIndex(x => x.id === id); if(idx > -1) db[idx] = taskData; else db.push(taskData);
        save(); toggleSidebar(false); clearForm();
    }
    function openEdit(id) {
        const t = db.find(x => x.id === id);
        document.getElementById('editId').value = t.id; document.getElementById('inDate').value = t.date; document.getElementById('inText').value = t.text; document.getElementById('inMemo').value = t.memo; document.getElementById('inType').value = t.type; document.getElementById('timeToggle').checked = t.hasTime;
        if(t.hasTime) { document.getElementById('sh').value = t.st.split(':')[0]; document.getElementById('sm').value = t.st.split(':')[1]; document.getElementById('eh').value = t.et.split(':')[0]; document.getElementById('em').value = t.et.split(':')[1]; }
        updateTimeVisibility(); document.getElementById('actionBtns').style.display = 'flex'; toggleSidebar(true); switchTab('form');
    }
    function toggleTaskDone() { const id = document.getElementById('editId').value; const task = db.find(t => t.id === id); if (task) { task.done = !task.done; save(); toggleSidebar(false); clearForm(); } }
    function deleteCurrentTask() { const id = document.getElementById('editId').value; if (id && confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) { db = db.filter(t => t.id !== id); save(); toggleSidebar(false); clearForm(); } }
    function clearForm() { document.getElementById('editId').value = ""; document.getElementById('inText').value = ""; document.getElementById('inMemo').value = ""; document.getElementById('actionBtns').style.display = 'none'; document.getElementById('timeToggle').checked = true; updateTimeVisibility(); }
    function save() { localStorage.setItem('creamy_v63', JSON.stringify(db)); render(); }
    function moveMonth(s) { viewDate.setMonth(viewDate.getMonth() + s); render(); }
    function toggleSidebar(show) { document.getElementById('sidebar').classList.toggle('active', show); document.getElementById('overlay').style.display = show ? 'block' : 'none'; }
    function handleTitleClick() { titleClicks++; if(titleClicks === 3) { toggleSidebar(true); titleClicks = 0; } setTimeout(() => titleClicks = 0, 800); }
    function updateTimeVisibility() { document.getElementById('timePickerSection').style.display = document.getElementById('timeToggle').checked ? 'block' : 'none'; }
    function switchTab(t) { document.getElementById('tabForm').style.display = t==='form' ? 'flex' : 'none'; document.getElementById('tabList').style.display = t==='list' ? 'flex' : 'none'; document.getElementById('btnForm').classList.toggle('active', t==='form'); document.getElementById('btnList').classList.toggle('active', t==='list'); if(t === 'list') renderFullList(); }
    function renderFullList() {
        const container = document.getElementById('fullListContainer'); container.innerHTML = '';
        db.sort((a,b) => b.date.localeCompare(a.date)).forEach(t => {
            const item = document.createElement('div'); item.style.padding = '14px'; item.style.background = '#FFF'; item.style.borderRadius = '12px'; item.style.border = '1px solid #EEE'; item.style.marginBottom = '8px';
            item.innerHTML = `<div style="font-size:0.75rem; font-weight:800; color:var(--m-brown);">${t.date}</div><div style="font-weight:800; ${t.done ? 'text-decoration:line-through; opacity:0.5;' : ''}">${t.text}</div>`;
            item.onclick = () => { openEdit(t.id); switchTab('form'); }; container.appendChild(item);
        });
    }
    function exportData() { const ds = btoa(unescape(encodeURIComponent(JSON.stringify(db)))); const temp = document.createElement('input'); document.body.appendChild(temp); temp.value = ds; temp.select(); document.execCommand('copy'); document.body.removeChild(temp); alert('åŒæ­¥ä»£ç¢¼å·²è¤‡è£½ï¼'); }
    function importData() { const c = prompt('è²¼ä¸Šä»£ç¢¼ï¼š'); if(!c) return; try { db = JSON.parse(decodeURIComponent(escape(atob(c)))); save(); alert('æˆåŠŸï¼'); } catch(e) { alert('å¤±æ•—ã€‚'); } }
    init();
</script>
</body>
</html>
